name: Deploy iOS to App Store

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mobile/**'

jobs:
  deploy-ios:
    name: Smart iOS Deployment
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create fingerprint
        id: fingerprint
        run: |
          npx @expo/fingerprint fingerprint:create --platform ios > fingerprint.json
          HASH=$(cat fingerprint.json | jq -r '.hash')
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "ğŸ“± Current fingerprint: $HASH"
      
      - name: Check for existing build
        id: check
        run: |
          BUILD=$(npx eas build:list --platform ios --status finished --json --non-interactive | jq -r --arg fp "${{ steps.fingerprint.outputs.hash }}" '.[] | select(.runtimeVersion == $fp) | .id' | head -1)
          if [[ -n "$BUILD" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found existing build with same fingerprint: $BUILD"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ No existing build found, native code changed"
          fi
      
      - name: Build and Submit to App Store
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "ğŸš€ Starting native build and App Store submission..."
          npx eas build --platform ios --profile production --auto-submit --non-interactive
          echo "âœ… Build and submission completed successfully"
      
      - name: OTA Update
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "âš¡ Deploying OTA update (JS/assets only)..."
          npx eas update --branch production --message "Auto update from main (commit: ${{ github.sha }})" --non-interactive
          echo "âœ… OTA update published successfully"
      
      - name: Comment deployment result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fingerprint = '${{ steps.fingerprint.outputs.hash }}';
            const buildExists = '${{ steps.check.outputs.exists }}';
            const deploymentType = buildExists === 'true' ? 'OTA Update âš¡' : 'Native Build & App Store Submission ğŸš€';
            const status = '${{ job.status }}' === 'success' ? 'âœ… Success' : 'âŒ Failed';
            
            const body = `## iOS Deployment ${status}
            
            **Type:** ${deploymentType}
            **Fingerprint:** \`${fingerprint}\`
            **Commit:** ${context.sha.substring(0, 7)}
            
            ${buildExists === 'false' ? 'ğŸ”¨ Native code changed - full build submitted to App Store' : 'âš¡ Only JS/assets changed - OTA update deployed'}
            
            ${buildExists === 'false' ? 'Track build progress: https://expo.dev/accounts/berkekahraman/projects/lilove/builds' : 'Users will receive the update on next app launch'}`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            })
