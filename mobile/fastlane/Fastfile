# Fastfile for LiLove iOS App Store Automation
# This file automates the App Store submission process

default_platform(:ios)

platform :ios do
  desc "Setup App Store Connect API Key"
  lane :setup_asc_key do
    # App Store Connect API Key configuration
    # Key ID should be set in environment variable ASC_KEY_ID
    # Issuer ID should be set in environment variable ASC_ISSUER_ID
    # Key content should be set in environment variable ASC_PRIVATE_KEY
    
    unless ENV["ASC_KEY_ID"]
      UI.user_error!("ASC_KEY_ID environment variable must be set. Do not hardcode API Key IDs.")
    end
    
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_PRIVATE_KEY"],
      duration: 1200, # 20 minutes
      in_house: false
    )
  end

  desc "Download metadata from App Store Connect"
  lane :download_metadata do
    setup_asc_key
    
    deliver_download_metadata(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      platform: "ios"
    )
  end

  desc "Upload metadata to App Store Connect"
  lane :upload_metadata do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload screenshots only"
  lane :upload_screenshots do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      force: true
    )
  end

  desc "Submit build for App Store review"
  lane :submit_review do |options|
    setup_asc_key
    
    build_number = options[:build_number]
    if build_number.nil?
      UI.user_error!("You must provide a build_number when submitting for review.")
    end
    
    deliver(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      app_version: "1.0.0",
      build_number: build_number,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        content_rights_contains_third_party_content: false
      }
    )
  end

  desc "Complete App Store submission flow"
  lane :release do |options|
    setup_asc_key
    
    build_number = options[:build_number]
    if build_number.nil?
      UI.user_error!("You must provide a build_number when running the release lane.")
    end
    
    # Upload metadata and screenshots
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      force: true
    )
    
    # Submit for review
    submit_review(build_number: build_number)
    
    UI.success("ðŸŽ‰ App successfully submitted to App Store for review!")
    UI.important("Monitor status at: https://appstoreconnect.apple.com/apps/6670815109")
  end

  desc "Build with EAS and submit to TestFlight"
  lane :beta do
    # This lane assumes EAS CLI is already installed and configured
    # Run: eas build --platform ios --profile production --non-interactive
    
    Dir.chdir('..') { sh("eas", "build", "--platform", "ios", "--profile", "production", "--non-interactive") }
    
    # The build will automatically be uploaded to TestFlight via EAS
    UI.success("ðŸŽ‰ Build submitted to TestFlight!")
  end

  desc "Update app metadata (descriptions, keywords, etc.)"
  lane :update_metadata do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end
end
