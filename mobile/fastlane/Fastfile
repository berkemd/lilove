# Fastfile for LiLove iOS App Store Automation
# This file automates the App Store submission process

default_platform(:ios)

platform :ios do
  desc "Setup App Store Connect API Key"
  lane :setup_asc_key do
    # App Store Connect API Key configuration
    # Key ID should be set in environment variable ASC_KEY_ID
    # Issuer ID should be set in environment variable ASC_ISSUER_ID
    # Key content should be set in environment variable ASC_PRIVATE_KEY
    
    unless ENV["ASC_KEY_ID"]
      UI.user_error!("ASC_KEY_ID environment variable must be set. Do not hardcode API Key IDs.")
    end
    
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_PRIVATE_KEY"],
      duration: 1200, # 20 minutes
      in_house: false
    )
  end

  desc "Download metadata from App Store Connect"
  lane :download_metadata do
    setup_asc_key
    
    deliver_download_metadata(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      platform: "ios"
    )
  end

  desc "Upload metadata to App Store Connect"
  lane :upload_metadata do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload screenshots only"
  lane :upload_screenshots do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      force: true
    )
  end

  desc "Submit build for App Store review"
  lane :submit_review do |options|
    setup_asc_key
    
    build_number = options[:build_number]
    if build_number.nil?
      UI.user_error!("You must provide a build_number when submitting for review.")
    end
    
    deliver(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      app_version: "1.0.0",
      build_number: build_number,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        content_rights_contains_third_party_content: false
      }
    )
  end

  desc "Complete App Store submission flow"
  lane :release do |options|
    setup_asc_key
    
    build_number = options[:build_number]
    if build_number.nil?
      UI.user_error!("You must provide a build_number when running the release lane.")
    end
    
    # Upload metadata and screenshots
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      force: true
    )
    
    # Submit for review
    submit_review(build_number: build_number)
    
    UI.success("ðŸŽ‰ App successfully submitted to App Store for review!")
    UI.important("Monitor status at: https://appstoreconnect.apple.com/apps/6670815109")
  end

  desc "Build with EAS and submit to TestFlight"
  lane :beta do
    # This lane assumes EAS CLI is already installed and configured
    # Run: eas build --platform ios --profile production --non-interactive
    
    Dir.chdir('..') { sh("eas", "build", "--platform", "ios", "--profile", "production", "--non-interactive") }
    
    # The build will automatically be uploaded to TestFlight via EAS
    UI.success("ðŸŽ‰ Build submitted to TestFlight!")
  end

  desc "Update app metadata (descriptions, keywords, etc.)"
  lane :update_metadata do
    setup_asc_key
    
    upload_to_app_store(
      username: "brkekahraman@icloud.com",
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end
end
# Fastfile for LiLove iOS Deployment
default_platform(:ios)

platform :ios do
  
  desc "Submit metadata to App Store"
  lane :submit_metadata do
    # Configure App Store Connect API key
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"] || "725AYMVS7J",
      issuer_id: ENV["ASC_ISSUER_ID"] || "69a6de96-a049-47e3-e053-5b8c7c11a4d1",
      key_filepath: ENV["ASC_KEY_PATH"] || "./AuthKey_725AYMVS7J.p8",
      in_house: false
    )
    
    # Upload metadata and screenshots
    deliver(
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: false,
      overwrite_screenshots: true,
      submit_for_review: false,
      automatic_release: false,
      force: true,
      
      # Metadata
      name: {
        "en-US" => "LiLove - AI Life Coach",
        "tr" => "LiLove - AI YaÅŸam KoÃ§u"
      },
      
      subtitle: {
        "en-US" => "Transform with AI Coaching",
        "tr" => "AI KoÃ§unla DÃ¶nÃ¼ÅŸÃ¼m"
      },
      
      description: {
        "en-US" => File.read("./fastlane/metadata/en-US/description.txt"),
        "tr" => File.read("./fastlane/metadata/tr/description.txt")
      },
      
      keywords: {
        "en-US" => "ai coach,life coach,habit tracker,goal setting,personal growth,mindfulness,wellness,self care,motivation",
        "tr" => "ai koÃ§,yaÅŸam koÃ§u,alÄ±ÅŸkanlÄ±k takibi,hedef belirleme,kiÅŸisel geliÅŸim,farkÄ±ndalÄ±k,saÄŸlÄ±k,motivasyon"
      },
      
      promotional_text: {
        "en-US" => "Transform your life with LiLove's AI coaching! Set goals, build habits, and grow with compassion. Your personal AI life coach awaits. Start your journey today! ðŸ’",
        "tr" => "LiLove'un AI koÃ§luÄŸuyla hayatÄ±nÄ±zÄ± dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n! Hedef belirleyin, alÄ±ÅŸkanlÄ±k oluÅŸturun ve ÅŸefkatle bÃ¼yÃ¼yÃ¼n. AI yaÅŸam koÃ§unuz sizi bekliyor! ðŸ’"
      },
      
      release_notes: {
        "en-US" => File.read("./fastlane/metadata/en-US/release_notes.txt"),
        "tr" => File.read("./fastlane/metadata/tr/release_notes.txt")
      },
      
      # App Information
      support_url: "https://lilove.org/support",
      marketing_url: "https://lilove.org",
      privacy_url: "https://lilove.org/privacy",
      
      # Categories
      primary_category: "HEALTH_AND_FITNESS",
      secondary_category: "LIFESTYLE",
      
      # App Review Information
      app_review_information: {
        first_name: "Berke",
        last_name: "Kahraman",
        phone_number: "+905321234567",
        email_address: "brkekahraman@icloud.com",
        demo_user: "demo@lilove.org",
        demo_password: "DemoLiLove2025!",
        notes: "Use the demo account to test premium features. The AI coach will guide you through onboarding."
      }
    )
    
    puts "âœ… Metadata submitted successfully!"
  end
  
  desc "Submit for App Store review"
  lane :submit_for_review do
    submit_metadata
    
    # Submit the app for review
    deliver(
      app_identifier: "org.lilove.app",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: true,
      submission_information: {
        add_id_info_uses_idfa: false,
        content_rights_contains_third_party_content: false,
        export_compliance_uses_encryption: false
      }
    )
    
    puts "âœ… App submitted for review!"
  end
  
  desc "Setup RevenueCat products"
  lane :setup_iap do
    # This would normally create IAP products via App Store Connect API
    # For now, providing the product IDs that need to be created manually
    puts "ðŸ“± Create these In-App Purchases in App Store Connect:"
    puts "1. lilove_premium_monthly - $9.99"
    puts "2. lilove_premium_yearly - $99.99"
    puts "3. lilove_team_monthly - $19.99"
    puts "4. lilove_team_yearly - $199.99"
  end
end
